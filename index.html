<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Bus Interaktif dengan Pop-up & Edit Mode</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        canvas { display: block; }

        /* Gaya untuk Kontrol (Menu Edit) */
        #controls-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
        }
        #controls-panel h3 {
            margin-top: 0;
            color: #333;
        }
        #controls-panel label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        #controls-panel input[type="checkbox"] {
            margin-right: 8px;
        }
        #controls-panel textarea {
            width: 100%;
            height: 100px;
            resize: vertical;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }
        #controls-panel button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }
        #controls-panel button:hover {
            background-color: #0056b3;
        }
        #current-object-name {
            background-color: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            color: #333;
            word-break: break-all;
        }

        /* Gaya untuk Pop-up Informasi */
        #info-popup {
            position: fixed;
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
            z-index: 2000; /* Lebih tinggi dari kontrol panel */
            display: none;
            max-width: 300px;
            transform: translate(-50%, -50%); /* Memposisikan di tengah berdasarkan ukuran sendiri */
            transition: opacity 0.3s ease;
        }
        #info-popup h3 {
            margin-top: 0;
            color: #007bff;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 10px;
        }
        #info-popup p {
            margin-bottom: 15px;
            color: #333;
            line-height: 1.5;
        }
        #info-popup button.close-button {
            background-color: #6c757d;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            float: right;
            transition: background-color 0.3s ease;
        }
        #info-popup button.close-button:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>

    <div id="controls-panel">
        <h3>Menu Edit Interaksi</h3>
        <label>
            <input type="checkbox" id="edit-mode-toggle"> Aktifkan Mode Edit
        </label>
        <div>
            <label for="current-object-name">Objek yang Diklik (Mode Edit):</label>
            <div id="current-object-name">Klik objek 3D</div>
        </div>
        <div>
            <label for="interactive-parts">Bagian Interaktif (Nama Objek, pisahkan dengan koma):</label>
            <textarea id="interactive-parts" placeholder="Contoh: Door_Front,Window_Left,Engine_Hood"></textarea>
            <small>Masukkan nama persis objek 3D yang ingin interaktif.</small>
        </div>
        <button onclick="saveInteractiveParts()">Simpan Bagian Interaktif</button>
        <p>
            Dalam mode edit, klik objek untuk melihat namanya. Salin nama yang relevan ke textarea di atas.
        </p>
    </div>

    <div id="info-popup">
        <button class="close-button" onclick="hideInfoPopup()">X</button>
        <h3 id="popup-title">Judul Pop-up</h3>
        <p id="popup-content">Konten informasi akan muncul di sini.</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // --- Inisialisasi Three.js ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Tambahkan OrbitControls untuk navigasi (putar, zoom)
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; // Efek "smooth" saat memutar
        controls.dampingFactor = 0.05;

        // Pencahayaan
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
        directionalLight.position.set(5, 10, 5);
        scene.add(directionalLight);
        const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
        directionalLight2.position.set(-5, -10, -5);
        scene.add(directionalLight2);

        // --- Variabel Global untuk Interaksi ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let currentIntersected = null; // Untuk highlight
        let modelBus = null; // Referensi ke grup model bus
        let editMode = false;
        let interactivePartNames = new Set(); // Set untuk menyimpan nama bagian interaktif

        // --- Elemen DOM ---
        const infoPopup = document.getElementById('info-popup');
        const popupTitle = document.getElementById('popup-title');
        const popupContent = document.getElementById('popup-content');
        const editModeToggle = document.getElementById('edit-mode-toggle');
        const currentObjectNameDisplay = document.getElementById('current-object-name');
        const interactivePartsTextarea = document.getElementById('interactive-parts');

        // --- Muat Model 3D OBJ (Bus) ---
        function loadBusModel() {
            console.log("Memulai pemuatan model bus...");
            const mtlLoader = new THREE.MTLLoader();
            mtlLoader.load('./model.mtl', function (materials) {
                materials.preload();
                console.log("MTL loaded successfully.");
                const objLoader = new THREE.OBJLoader();
                objLoader.setMaterials(materials);
                objLoader.load('./model.obj', function (object) {
                    modelBus = object; // Simpan referensi ke model bus
                    scene.add(modelBus);
                    console.log("OBJ loaded successfully and added to scene.");

                    // --- Penyesuaian Kamera Otomatis ---
                    // Ini penting jika model terlalu besar atau kecil
                    const bbox = new THREE.Box3().setFromObject(modelBus);
                    const center = new THREE.Vector3();
                    bbox.getCenter(center);
                    const size = new THREE.Vector3();
                    bbox.getSize(size);

                    const maxDim = Math.max(size.x, size.y, size.z);
                    const fov = camera.fov * (Math.PI / 180); // Ubah FOV ke radian
                    let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
                    cameraZ *= 1.5; // Sedikit lebih jauh untuk memberikan ruang
                    
                    camera.position.set(center.x, center.y, center.z + cameraZ);
                    camera.lookAt(center); // Arahkan kamera ke tengah model
                    controls.target.copy(center); // Set target controls ke tengah model
                    controls.update(); // Perbarui controls setelah perubahan kamera/target

                    console.log("Model bounding box size:", size);
                    console.log("Model center:", center);
                    console.log("Kamera diatur ke:", camera.position);


                    // Log semua nama mesh untuk debugging dan menentukan bagian interaktif
                    console.log("Nama-nama mesh dalam model:");
                    object.traverse(function(child) {
                        if (child.isMesh) {
                            console.log(' - ' + child.name);
                        }
                    });

                },
                function (xhr) {
                    // Progress OBJ
                    console.log('OBJ progress: ' + (xhr.loaded / xhr.total * 100).toFixed(2) + '% loaded');
                },
                function (error) {
                    console.error('An error happened loading OBJ:', error);
                    // Detail error dari Three.js seringkali sangat membantu
                    if (error.message) console.error("Error message:", error.message);
                });
            },
            function (xhr) {
                // Progress MTL
                console.log('MTL progress: ' + (xhr.loaded / xhr.total * 100).toFixed(2) + '% loaded');
            },
            function (error) {
                console.error('An error happened loading MTL:', error);
                if (error.message) console.error("Error message:", error.message);
            });
        }
        loadBusModel();

        // --- Fungsi Animasi Render ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update(); // Perbarui OrbitControls setiap frame
            renderer.render(scene, camera);
        }
        animate();

        // --- Penanganan Ukuran Jendela ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // --- Raycasting (Deteksi Klik pada Objek 3D) ---
        window.addEventListener('mousemove', onMouseMove); // Untuk highlight (opsional)
        window.addEventListener('click', onMouseClick);

        function onMouseMove(event) {
            if (!modelBus) return; // Pastikan model sudah dimuat

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            // Periksa interaksi hanya dengan children dari model bus (bukan scene.children)
            // Ini penting untuk efisiensi dan fokus pada model bus saja
            const intersects = raycaster.intersectObjects(modelBus.children, true);

            if (intersects.length > 0) {
                const hoveredObject = intersects[0].object;
                if (currentIntersected !== hoveredObject) {
                    if (currentIntersected && currentIntersected.material) {
                        // Kembalikan warna objek sebelumnya jika ada
                        if (currentIntersected.material.originalColor) {
                             currentIntersected.material.color.copy(currentIntersected.material.originalColor);
                             delete currentIntersected.material.originalColor; // Hapus properti tambahan
                        } else if (Array.isArray(currentIntersected.material)) { // Handle multiple materials
                            currentIntersected.material.forEach(mat => {
                                if (mat.originalColor) {
                                    mat.color.copy(mat.originalColor);
                                    delete mat.originalColor;
                                }
                            });
                        }
                    }
                    currentIntersected = hoveredObject;
                    // Simpan warna asli sebelum mengubahnya
                    if (currentIntersected.material) {
                         if (Array.isArray(currentIntersected.material)) {
                            currentIntersected.material.forEach(mat => {
                                if (!mat.originalColor) mat.originalColor = mat.color.clone();
                                mat.color.set(0x00ff00); // Warna hijau terang untuk highlight
                            });
                         } else {
                            if (!currentIntersected.material.originalColor) currentIntersected.material.originalColor = currentIntersected.material.color.clone();
                            currentIntersected.material.color.set(0x00ff00); // Warna hijau terang untuk highlight
                         }
                    }
                    renderer.domElement.style.cursor = 'pointer'; // Ubah kursor
                }
            } else {
                if (currentIntersected && currentIntersected.material) {
                    // Kembalikan warna jika tidak ada lagi yang dihover
                    if (currentIntersected.material.originalColor) {
                        currentIntersected.material.color.copy(currentIntersected.material.originalColor);
                        delete currentIntersected.material.originalColor;
                    } else if (Array.isArray(currentIntersected.material)) {
                        currentIntersected.material.forEach(mat => {
                            if (mat.originalColor) {
                                mat.color.copy(mat.originalColor);
                                delete mat.originalColor;
                            }
                        });
                    }
                }
                currentIntersected = null;
                renderer.domElement.style.cursor = 'grab'; // Kembalikan kursor default
            }
        }


        function onMouseClick(event) {
            if (!modelBus) return; // Pastikan model sudah dimuat

            // Raycasting untuk mendeteksi klik
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            // Periksa interaksi hanya dengan children dari modelBus
            const intersects = raycaster.intersectObjects(modelBus.children, true);

            if (intersects.length > 0) {
                const clickedObject = intersects[0].object;

                if (editMode) {
                    // Mode Edit: Tampilkan nama objek
                    const objName = clickedObject.name || "Nama objek tidak tersedia";
                    currentObjectNameDisplay.textContent = objName;
                    console.log('Clicked in Edit Mode:', objName, clickedObject);
                    // Memberikan feedback visual klik di mode edit (opsional)
                    if (clickedObject.material) {
                        if (Array.isArray(clickedObject.material)) {
                            clickedObject.material.forEach(mat => {
                                if (!mat.originalColor) mat.originalColor = mat.color.clone();
                                mat.color.set(0xffa500); // Warna oranye untuk klik di edit mode
                            });
                        } else {
                            if (!clickedObject.material.originalColor) clickedObject.material.originalColor = clickedObject.material.color.clone();
                            clickedObject.material.color.set(0xffa500); // Warna oranye untuk klik di edit mode
                        }
                    }
                    setTimeout(() => { // Kembalikan warna setelah jeda singkat
                        if (clickedObject.material) {
                            if (Array.isArray(clickedObject.material)) {
                                clickedObject.material.forEach(mat => {
                                    if (mat.originalColor) {
                                        mat.color.copy(mat.originalColor);
                                        delete mat.originalColor;
                                    }
                                });
                            } else {
                                if (clickedObject.material.originalColor) {
                                    clickedObject.material.color.copy(clickedObject.material.originalColor);
                                    delete clickedObject.material.originalColor;
                                }
                            }
                        }
                    }, 500); // 0.5 detik
                } else {
                    // Mode Normal: Periksa apakah objek ini interaktif
                    if (interactivePartNames.has(clickedObject.name)) {
                        const info = getInfoForPart(clickedObject.name);
                        showInfoPopup(info.title, info.content, event.clientX, event.clientY);
                    } else {
                        hideInfoPopup(); // Sembunyikan pop-up jika bukan bagian interaktif
                    }
                }
            } else {
                // Jika klik tidak mengenai objek apapun
                if (!editMode) {
                    hideInfoPopup(); // Sembunyikan pop-up di mode normal
                }
            }
        }

        // --- Logika Mode Edit ---
        editModeToggle.addEventListener('change', (event) => {
            editMode = event.target.checked;
            if (!editMode) {
                currentObjectNameDisplay.textContent = 'Klik objek 3D'; // Reset display
            }
            console.log('Edit Mode:', editMode);
        });

        function saveInteractiveParts() {
            const partNamesString = interactivePartsTextarea.value.trim();
            const namesArray = partNamesString.split(',').map(name => name.trim()).filter(name => name !== '');
            interactivePartNames = new Set(namesArray);
            console.log('Bagian Interaktif Disimpan:', Array.from(interactivePartNames));
            alert('Daftar bagian interaktif telah diperbarui!');
        }

        // --- Logika Pop-up Informasi ---
        function showInfoPopup(title, content, clientX, clientY) {
            popupTitle.textContent = title;
            popupContent.textContent = content;

            // Posisikan pop-up relatif terhadap elemen kontrol jika ingin terpusat di sana
            // Atau tetap relatif terhadap mouse jika ingin fleksibel
            infoPopup.style.left = `${clientX + 10}px`; // Sedikit offset dari kursor
            infoPopup.style.top = `${clientY + 10}px`;
            infoPopup.style.display = 'block';

            // Memastikan pop-up tidak keluar dari viewport (perbaikan sederhana)
            const rect = infoPopup.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                infoPopup.style.left = `${clientX - rect.width - 10}px`;
            }
            if (rect.bottom > window.innerHeight) {
                infoPopup.style.top = `${clientY - rect.height - 10}px`;
            } else if (rect.top < 0) { // Jika pop-up terlalu ke atas
                infoPopup.style.top = `10px`;
            }
        }

        function hideInfoPopup() {
            infoPopup.style.display = 'none';
        }

        // --- Fungsi untuk Mendapatkan Info Pop-up Berdasarkan Nama Bagian ---
        // Anda BISA KUSTOMISASI ini untuk setiap bagian yang Anda inginkan
        function getInfoForPart(partName) {
            switch (partName) {
                case 'Door_Front': // Ganti dengan nama mesh pintu depan Anda
                    return {
                        title: 'Pintu Depan Bus',
                        content: 'Ini adalah pintu masuk utama bus. Digunakan untuk naik dan turun penumpang.'
                    };
                case 'Window_Left': // Ganti dengan nama mesh jendela kiri Anda
                    return {
                        title: 'Jendela Samping',
                        content: 'Jendela ini memberikan pemandangan luar dan pencahayaan alami di dalam bus.'
                    };
                case 'Engine_Hood': // Ganti dengan nama mesh kap mesin Anda
                    return {
                        title: 'Kompartemen Mesin',
                        content: 'Di sinilah mesin bus berada, pusat tenaga penggerak.'
                    };
                case 'Tyre_Front_Left': // Contoh lain
                    return {
                        title: 'Ban Depan Kiri',
                        content: 'Komponen vital untuk pergerakan dan stabilitas bus.'
                    };
                // Tambahkan case lain sesuai dengan nama bagian yang Anda temukan di mode edit
                default:
                    return {
                        title: 'Info Objek',
                        content: `Ini adalah bagian: ${partName}. Tambahkan informasi di fungsi getInfoForPart().`
                    };
            }
        }

        // --- Initial setup for textarea with example values (optional) ---
        // Anda bisa mengomentari ini setelah Anda punya daftar bagian interaktif Anda sendiri
        // interactivePartsTextarea.value = "Door_Front,Window_Left,Engine_Hood"; // Contoh nama bagian
        // saveInteractiveParts(); // Muat nilai awal saat halaman dimuat
    </script>
</body>
</html>